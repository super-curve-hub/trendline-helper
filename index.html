<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Trendline Break Helper (4H → 15M)</title>
<style>
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;margin:12px;background:#fff;color:#111}
h1{font-size:18px;margin:6px 0}
.note{font-size:12px;color:#555;margin-bottom:10px}
.container{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.container{grid-template-columns:420px 1fr}}
.panel{border:1px solid #ddd;border-radius:10px;padding:10px}
.row{display:grid;grid-template-columns:1fr;gap:6px;margin-bottom:10px}
@media(min-width:768px){.row{grid-template-columns:160px 1fr}}
.label{font-size:13px;font-weight:600}
input,select,button{width:100%;min-height:38px;padding:6px 8px;font-size:14px}
.buttons{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-bottom:10px}
canvas{width:100%;border:1px solid #ddd;border-radius:10px;touch-action:none}
.output{margin-top:10px;border:1px solid #ddd;border-radius:10px;padding:10px;font-family:ui-monospace,monospace;font-size:13px;white-space:pre-wrap}
.status{font-size:12px;color:#555;margin-bottom:6px}
</style>
</head>
<body>
<h1>Trendline Break Helper（4Hで確定 → 15Mで執行）</h1>
<div class="note">教育・検証補助用。最終判断は利用者責任。</div>

<div class="container">
<div class="panel">
<div class="row"><div class="label">チャート画像</div><input type="file" id="fileInput" accept="image/*"></div>
<div class="row"><div class="label">方向</div>
<select id="side"><option value="short">Short（下抜け）</option><option value="long">Long（上抜け）</option></select></div>
<div class="row"><div class="label">buf</div><input type="number" id="buf" step="0.01" value="0.05"></div>
<div class="row"><div class="label">bufS</div><input type="number" id="bufS" step="0.01" value="0.05"></div>
<div class="row"><div class="label">Rmax</div><input type="number" id="rmax" step="0.01" value="0.30"></div>
<div class="row"><div class="label">TP倍率</div><input type="number" id="k" step="0.1" value="1.5"></div>

<div class="row"><div class="label">15M pullbackTol</div>
<input type="number" id="pullbackTol" step="0.01" value="0.10"></div>
<div class="row"><div class="label">15M chaseMax</div>
<input type="number" id="chaseMax" step="0.01" value="0.05"></div>

<div class="row"><div class="label">現在値</div><input type="number" id="pxNow" step="0.001"></div>

<div class="buttons">
<button id="cal1">① キャリブ1</button>
<button id="cal2">① キャリブ2</button>
<button id="nowX">② Now</button>
<button id="al">③ Action</button>
<button id="sl">④ Safety</button>
<button id="px">⑤ 現在値</button>
</div>
<div class="buttons">
<button id="calc">計算</button>
<button id="reset">リセット</button>
</div>
</div>

<div>
<canvas id="cv" width="1200" height="800"></canvas>
<div class="panel" style="margin-top:10px">
<div class="status" id="status">画像をアップロードしてください。</div>
<div class="output" id="output"></div>
</div>
</div>
</div>

<script>
const canvas=document.getElementById("cv"),ctx=canvas.getContext("2d");
const statusEl=document.getElementById("status"),out=document.getElementById("output");
let img=new Image();
let mode=null,calib={p1:null,p2:null},nowX=null,al=[],sl=[];

fileInput.onchange=e=>{
 const f=e.target.files[0]; if(!f) return;
 const r=new FileReader();
 r.onload=()=>{img.onload=()=>{canvas.width=img.width;canvas.height=img.height;ctx.drawImage(img,0,0);reset(false)};img.src=r.result};
 r.readAsDataURL(f);
};

function reset(all=true){
 mode=null;calib={p1:null,p2:null};nowX=null;al=[];sl=[];out.textContent="";
 if(all){pxNow.value="";}
 if(img.src){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.drawImage(img,0,0);}
 statusEl.textContent="①からやり直してください";
}

["cal1","cal2","nowX","al","sl","px"].forEach(id=>{
 document.getElementById(id).onclick=()=>{mode=id};
});

canvas.onclick=e=>{
 if(!mode||!img.src) return;
 const r=canvas.getBoundingClientRect();
 const x=(e.clientX-r.left)*canvas.width/r.width;
 const y=(e.clientY-r.top)*canvas.height/r.height;
 ctx.fillStyle="yellow";ctx.beginPath();ctx.arc(x,y,5,0,Math.PI*2);ctx.fill();

 if(mode==="cal1"||mode==="cal2"){
  const p=prompt("価格入力"); if(!p) return;
  calib[mode==="cal1"?"p1":"p2"]={x,y,price:+p}; mode=null;
 }
 else if(mode==="nowX"){nowX=x;mode=null}
 else if(mode==="al"){al.push({x,y});if(al.length===2){drawLine(al,"cyan");mode=null}}
 else if(mode==="sl"){sl.push({x,y});if(sl.length===2){drawLine(sl,"orange");mode=null}}
 else if(mode==="px"){pxNow.value=priceAtY(y).toFixed(3);mode=null}
};

function drawLine(pts,color){ctx.strokeStyle=color;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);ctx.lineTo(pts[1].x,pts[1].y);ctx.stroke()}
function priceAtY(y){const a=(calib.p2.price-calib.p1.price)/(calib.p2.y-calib.p1.y);return calib.p1.price+a*(y-calib.p1.y)}
function linePxAtX(pts,x){const m=(pts[1].y-pts[0].y)/(pts[1].x-pts[0].x);const y=m*(x-pts[0].x)+pts[0].y;return priceAtY(y)}

function drawZone(y,color,label){
 ctx.fillStyle=color;ctx.globalAlpha=0.15;ctx.fillRect(0,y-6,canvas.width,12);
 ctx.globalAlpha=1;ctx.strokeStyle=color;ctx.lineWidth=4;
 ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();
 ctx.fillStyle=color;ctx.fillText(label,10,y-8);
}

calc.onclick=()=>{
 if(!calib.p1||!calib.p2||nowX===null||al.length<2||sl.length<2){out.textContent="未設定があります";return}
 const side=document.getElementById("side").value;
 const bufv=+buf.value,bufSv=+bufS.value,kv=+k.value;
 const action=linePxAtX(al,nowX),safety=linePxAtX(sl,nowX);
 if(side==="short"&&safety<=action){out.textContent="SafetyはActionより上";return}
 if(side==="long"&&safety>=action){out.textContent="SafetyはActionより下";return}

 let entry=side==="short"?action-bufv:action+bufv;
 let stop =side==="short"?safety+bufSv:safety-bufSv;
 let R=Math.abs(entry-stop);
 let tp=side==="short"?entry-R*kv:entry+R*kv;

 const f=y=> (calib.p2.y-calib.p1.y)*(y-calib.p1.price)/(calib.p2.price-calib.p1.price)+calib.p1.y;
 drawZone(f(entry),"red","ENTRY");
 drawZone(f(stop),"orange","STOP");
 drawZone(f(tp),"green","TP");

 let px=+pxNow.value;
 let exec="現在値未入力";
 if(px){
  const pull=+pullbackTol.value, chase=+chaseMax.value;
  if(side==="short"){
    if(px<entry && entry-px<=chase) exec="15M 成行";
    else if(px>entry && px-entry<=pull) exec="15M 戻り指値";
    else exec="見送り";
  }else{
    if(px>entry && px-entry<=chase) exec="15M 成行";
    else if(px<entry && entry-px<=pull) exec="15M 押し目指値";
    else exec="見送り";
  }
 }

 out.textContent=`Entry:${entry.toFixed(3)}\nStop:${stop.toFixed(3)}\nTP:${tp.toFixed(3)}\n15M判断:${exec}`;
};
reset.onclick=()=>reset(true);
</script>
</body>
</html>
