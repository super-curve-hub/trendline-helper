<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Trendline Break Helper (4H → 15M)</title>

<style>
/* ====== 安全装置 ====== */
*,
*::before,
*::after {
  box-sizing: border-box;
}

/* ====== 全体 ====== */
body {
  font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
  margin: 16px;
  background: #fff;
  color: #111;
}

h1 {
  font-size: 20px;
  margin-bottom: 8px;
}

.note {
  font-size: 12px;
  color: #555;
  margin-bottom: 12px;
}

/* ====== レイアウト ====== */
.container {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
}

@media (min-width: 900px) {
  .container {
    grid-template-columns: 420px 1fr;
    align-items: start;
  }
}

.panel {
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 12px;
}

/* ====== フォーム行 ====== */
.row {
  display: grid;
  grid-template-columns: 1fr;
  gap: 6px;
  margin-bottom: 12px;
}

/* PCではラベル＋入力の2列 */
@media (min-width: 768px) {
  .row {
    grid-template-columns: 160px 1fr;
    align-items: center;
    gap: 8px;
  }
}

.label {
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
}

/* ====== 入力 ====== */
input,
select,
button {
  width: 100%;
  min-height: 40px;
  padding: 6px 8px;
  font-size: 14px;
}

button {
  cursor: pointer;
}

/* ====== ボタン群 ====== */
.buttons {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 8px;
  margin-bottom: 12px;
}

/* ====== Canvas ====== */
canvas {
  width: 100%;
  border: 1px solid #ddd;
  border-radius: 10px;
  touch-action: none;
}

/* ====== 出力 ====== */
.output {
  margin-top: 12px;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 10px;
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
  font-size: 13px;
  white-space: pre-wrap;
}

.status {
  font-size: 12px;
  color: #555;
  margin-bottom: 6px;
}
</style>
</head>

<body>
<h1>Trendline Break Helper（4Hでライン確定 → 15Mで執行）</h1>
<div class="note">
※ 教育・検証補助用ツールです。売買判断の最終責任は利用者にあります。
</div>

<div class="container">
  <!-- ===== 左パネル ===== -->
  <div class="panel">
    <div class="row">
      <div class="label">チャート画像</div>
      <input type="file" id="fileInput" accept="image/*">
    </div>

    <div class="row">
      <div class="label">方向</div>
      <select id="side">
        <option value="long">Long（上抜け）</option>
        <option value="short">Short（下抜け）</option>
      </select>
    </div>

    <div class="row">
      <div class="label">buf（ブレイク判定）</div>
      <input type="number" id="buf" step="0.01" value="0.05">
    </div>

    <div class="row">
      <div class="label">bufS（ストップ余裕）</div>
      <input type="number" id="bufS" step="0.01" value="0.05">
    </div>

    <div class="row">
      <div class="label">Rmax（低リスク上限）</div>
      <input type="number" id="rmax" step="0.01" value="0.30">
    </div>

    <div class="row">
      <div class="label">TP倍率（主）</div>
      <input type="number" id="k" step="0.1" value="1.5">
    </div>

    <div class="row">
      <div class="label">現在値（任意）</div>
      <input type="number" id="pxNow" step="0.001" placeholder="クリックで取得 or 手入力">
    </div>

    <div class="buttons">
      <button id="cal1">① キャリブ点1</button>
      <button id="cal2">① キャリブ点2</button>
      <button id="nowX">② Now位置</button>
      <button id="al">③ Action Line</button>
      <button id="sl">④ Safety Line</button>
      <button id="px">⑤ 現在値クリック</button>
    </div>

    <div class="buttons">
      <button id="calc">計算</button>
      <button id="reset">リセット</button>
    </div>

    <div class="note">
      手順：<br>
      ① 価格軸の2点をクリックして価格入力<br>
      ② 最新足のX位置をクリック<br>
      ③ Action Line（2点）<br>
      ④ Safety Line（2点）<br>
      ⑤ 任意：現在値
    </div>
  </div>

  <!-- ===== 右側 ===== -->
  <div>
    <canvas id="cv" width="1200" height="800"></canvas>

    <div class="panel" style="margin-top:12px;">
      <div class="status" id="status">画像をアップロードしてください。</div>
      <div class="output" id="output"></div>
    </div>
  </div>
</div>
<script>
/* ===== Canvas & Image Load ===== */

const fileInput = document.getElementById("fileInput");
const canvas = document.getElementById("cv");
const ctx = canvas.getContext("2d");
const statusEl = document.getElementById("status");

let img = new Image();

fileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = () => {
    img.onload = () => {
      // ★超重要：canvas実サイズを画像に合わせる
      canvas.width = img.width;
      canvas.height = img.height;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);

      statusEl.textContent =
        "画像を読み込みました。①キャリブ点1から進めてください。";
    };

    img.src = reader.result;
  };

  reader.readAsDataURL(file);
});
</script>
</body>
</html>
